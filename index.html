<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FBPM · Панель-корабель проєкту (з Планом ІР)</title>
  <meta name="description" content="Об'єднаний клієнтський дешборд для впровадження FBPM: Health, майлстони, зустрічі, документи, задачі, та повний План впровадження ІР зі стадіями і ролями."/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand-primary:#392EC9; /* Persian Blue */
      --brand-accent:#EF0650;  /* Amaranth */
      --brand-sky:#83C8FA;     /* Light Sky Blue */
      --brand-oxford:#0B132B;  /* Oxford Blue */
      --brand-bg:#F5F5FC;      /* Soft Gray */
      --brand-line:#E7E7EA;    /* Lines */
      --ok:#27AE60;            /* Success */
      --risk:#F2C94C;          /* Warning */
      --block:#EB5757;         /* Error */
      --panel:#FFFFFF; --muted:#6B7280; --shadow:0 10px 25px rgba(11,19,43,.08); --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--brand-oxford);background:linear-gradient(180deg,#EBEAFA 0%, var(--brand-bg) 100%);} 
    a{color:var(--brand-primary);text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1200px;margin:32px auto;padding:0 16px}
    .grid{display:grid;gap:16px}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .panel{background:var(--panel);border:1px solid var(--brand-line);border-radius:var(--radius);box-shadow:var(--shadow);} .panel.pad{padding:20px}
    .title{font-weight:700;letter-spacing:.2px}
    .muted{color:var(--muted)}
    .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--brand-line);padding:8px 12px;border-radius:999px;background:#fff;cursor:pointer;user-select:none}
    .chip.active{border-color:var(--brand-primary);box-shadow:0 0 0 3px rgba(57,46,201,.08)}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border-radius:12px;border:1px solid var(--brand-line);background:#fff;cursor:pointer;transition:transform .05s ease, box-shadow .15s ease}
    .btn:hover{box-shadow:0 6px 16px rgba(11,19,43,.08)}
    .btn.primary{background:linear-gradient(90deg,var(--brand-primary), var(--brand-accent));color:#fff;border-color:transparent}
    .btn.ghost{background:#fff}
    .btn:active{transform:translateY(1px)}
    .btn:focus-visible{outline:3px solid var(--brand-primary);outline-offset:2px}
    .hero{padding:22px}
    .hero .title{font-size:26px}
    .hero .sub{display:flex;gap:12px;flex-wrap:wrap;margin-top:6px}
    .health{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border-radius:999px;border:1px solid var(--brand-line);background:#fff}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.g{background:var(--ok)} .dot.y{background:var(--risk)} .dot.r{background:var(--block)}
    .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    .kpi{padding:16px;border-radius:16px;border:1px solid var(--brand-line);background:#fff;box-shadow:var(--shadow)}
    .kpi h4{margin:0 0 6px;font-size:13px;font-weight:600;color:var(--muted)}
    .kpi .v{font-size:24px;font-weight:700}
    .kpi .hint{font-size:12px;color:var(--muted)}
    .cols{display:grid;grid-template-columns:2fr 1.2fr;gap:16px}
    .timeline{position:relative;padding:8px 8px 12px 8px}
    .timeline .rail{height:4px;background:#D7D5F4;border-radius:999px;margin:24px 0}
    .timeline .marks{display:flex;gap:18px;overflow:auto;padding-bottom:6px}
    .mark{min-width:220px;background:#fff;border:1px solid var(--brand-line);border-radius:12px;padding:12px;box-shadow:var(--shadow)}
    .mark .when{font-size:12px;color:var(--muted)} .mark .name{font-weight:600;margin-top:4px}
    .mark.done{border-color:#C4C0EF} .mark.now{border-color:var(--brand-accent)} .mark.next{border-color:var(--brand-primary)}
    .list{display:grid;gap:8px}
    .item{padding:12px;border:1px solid var(--brand-line);border-radius:12px;background:#fff}
    .table{width:100%;border-collapse:separate;border-spacing:0 8px}
    .table th{font-size:12px;font-weight:600;color:var(--muted);text-align:left;padding:0 12px}
    .table td{background:#fff;border:1px solid var(--brand-line);border-left:none;border-right:none;padding:12px}
    .table tr td:first-child{border-radius:12px 0 0 12px;border-left:1px solid var(--brand-line)}
    .table tr td:last-child{border-radius:0 12px 12px 0;border-right:1px solid var(--brand-line)}
    .cards{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .card{padding:14px;border:1px solid var(--brand-line);border-radius:14px;background:#fff;box-shadow:var(--shadow)}
    .filters{display:flex;gap:8px;flex-wrap:wrap}
    .footer{margin:24px 0 48px;color:var(--muted);font-size:12px;text-align:center}
    .stage{background:#fff;border:1px solid var(--brand-line);border-radius:16px;padding:16px;box-shadow:var(--shadow);margin-bottom:12px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--brand-line)}
    .role-ex{background:rgba(57,46,201,.08);border-color:var(--brand-primary);color:var(--brand-primary)}
    .role-cl{background:rgba(239,6,80,.1);border-color:var(--brand-accent);color:var(--brand-accent)}
    .role-bo{background:rgba(131,200,250,.2);border-color:var(--brand-sky);color:var(--brand-oxford)}
    .task{display:flex;gap:10px;align-items:flex-start;padding:10px 0;border-top:1px dashed var(--brand-line)} .task:first-child{border-top:none}
    @media (max-width: 980px){ .kpis{grid-template-columns:repeat(2,1fr)} .cols{grid-template-columns:1fr} .cards{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <main class="wrap grid">
    <section class="panel hero" aria-labelledby="hero-title">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <div id="hero-title" class="title">Проєкт: FBPM · Впровадження для ІР</div>
          <div class="sub">
            <span class="chip">Фаза: <strong id="phase">—</strong></span>
            <span class="chip">Завершено: <strong id="pct">—</strong></span>
            <span class="chip">Наступний крок: <strong id="nextM">—</strong></span>
            <span class="chip">D-days: <strong id="ddays">—</strong></span>
          </div>
          <div class="health" role="status" aria-live="polite">
            <span class="pill"><span class="dot g" id="scopeDot" aria-hidden="true"></span> Scope</span>
            <span class="pill"><span class="dot y" id="schedDot" aria-hidden="true"></span> Schedule</span>
            <span class="pill"><span class="dot g" id="budgetDot" aria-hidden="true"></span> Budget</span>
          </div>
        </div>
        <div class="row" style="gap:8px">
          <button class="btn ghost" id="btnFilters" type="button">Фільтри</button>
          <a class="btn primary" id="askPM" href="#">Поставити питання PM</a>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="chip" id="need1">—</div>
        <div class="chip" id="need2">—</div>
        <div class="chip" id="need3">—</div>
      </div>
    </section>

    <section class="kpis" aria-label="KPI">
      <div class="kpi"><h4>Задач виконано</h4><div class="v" id="k_done">—</div><div class="hint" id="k_done_hint">усього / демо</div></div>
      <div class="kpi"><h4>Просрочені</h4><div class="v" id="k_over">—</div><div class="hint">активні блокери</div></div>
      <div class="kpi"><h4>В очікуванні</h4><div class="v" id="k_dec">—</div><div class="hint">тип: waiting/pending</div></div>
      <div class="kpi"><h4>Готовність модулів</h4><div class="v" id="k_mod">—</div><div class="hint">за виконанням задач</div></div>
    </section>

    <section class="cols">
      <div class="panel pad" aria-labelledby="ms-title">
        <div class="row" style="justify-content:space-between;align-items:center"><div id="ms-title" class="title">Майлстони</div><div class="muted">Burn‑up, послідовність і Gantt</div></div>
        <div class="timeline">
          <div class="rail" aria-hidden="true"></div>
          <div class="marks" id="marks"></div>
        </div>
      </div>

      <div class="panel pad">
        <div class="title">Що змінилося за тиждень</div>
        <ul class="list" id="diff"></ul>
        <div style="margin-top:8px" class="filters" id="filters"></div>
      </div>
    </section>

    <section class="cols">
      <div class="panel pad">
        <div class="row" style="justify-content:space-between;align-items:center"><div class="title">Історія взаємодії (зустрічі/питання/рішення)</div>
          <input id="searchTag" class="chip" placeholder="#UAT / #Budget / #OCR" style="border:none;outline:none" />
        </div>
        <table class="table" style="margin-top:10px">
          <thead><tr><th>Дата</th><th>Тип</th><th>Заголовок</th><th>Коротко</th><th>Лінк</th></tr></thead>
          <tbody id="histBody"></tbody>
        </table>
        <div class="row" style="margin-top:10px;gap:8px">
          <input id="histTitle" class="chip" placeholder="Заголовок…" style="border:none;outline:none" />
          <input id="histSummary" class="chip" placeholder="Короткий зміст…" style="border:none;outline:none;flex:1" />
          <select id="histType" class="chip" style="border:none;outline:none">
            <option>зустріч</option><option>питання</option><option>відповідь</option><option>рішення</option><option>нотатка</option>
          </select>
          <input id="histLink" class="chip" placeholder="Посилання (опц.)" style="border:none;outline:none" />
          <button class="btn" id="histAdd" type="button">Додати</button>
        </div>
      </div>

      <div class="panel pad">
        <div class="row" style="justify-content:space-between;align-items:center"><div class="title">Документи</div>
          <div class="filters"><span class="chip" data-docf="Approved">Approved</span><span class="chip" data-docf="Draft">Draft</span><span class="chip chip-doc-all active" data-docf="">Всі</span></div>
        </div>
        <div class="cards" id="docs"></div>
      </div>
    </section>

    <section class="panel pad">
      <div class="row" style="justify-content:space-between;align-items:center"><div class="title">План впровадження ІР</div>
        <div class="filters">
          <span class="chip active" data-sf="all">Всі етапи</span>
          <span class="chip" data-sf="preNY">До НР (1–3)</span>
          <span class="chip" data-sf="postNY">Після НР (4–6)</span>
          <span class="chip active" data-rf="executor">Виконавець</span>
          <span class="chip active" data-rf="client">Клієнт</span>
          <span class="chip active" data-rf="both">Разом</span>
        </div>
      </div>
      <div id="planWrap"></div>
    </section>

    <section class="panel pad">
      <div class="row" style="justify-content:space-between;align-items:center"><div class="title">Задачі / Інциденти</div>
        <div class="filters">
          <span class="chip" data-f="phase:Пілот">Фаза: Пілот</span>
          <span class="chip" data-f="mod:PO">PO</span>
          <span class="chip" data-f="mod:Integrations">Integrations</span>
          <span class="chip" data-f="owner:PM">PM</span>
          <span class="chip chip-task-all active" data-f="all:all">Всі</span>
        </div>
      </div>
      <table class="table" style="margin-top:10px">
        <thead><tr><th>Назва</th><th>Пріоритет</th><th>Відповідальний</th><th>ETA</th><th>Статус</th></tr></thead>
        <tbody id="taskBody"></tbody>
      </table>
    </section>

    <div class="footer">ABM Cloud · FBPM Dashboard + План ІР · Версія 0.4 · Статичний HTML/JS · Шрифти Montserrat · Кольори бренду</div>
  </main>

<script>
  const MAIL = 'mailto:riae@abmcloud.com'
  const HIST_GET_ENDPOINT  = 'https://finbpm3.app.n8n.cloud/webhook/6bf259a0-7012-466b-9a35-314fa54daea3'
  const HIST_POST_ENDPOINT = 'https://finbpm3.app.n8n.cloud/webhook/6bf259a0-7012-466b-9a35-314fa54daea3'

  const PLAN = [
    { id:1, title:'Етап 1. Оновлення ТЗ, підготовка та розгортання', duration:'2–3 тижні', goal:'Узгодити PRD v2.0, розгорнути систему на сервері, організувати аналітику та план реалізації.', period:'preNY',
      results:['PRD v2.0 та Project Plan v1.0','Тестова інстанція Finance BPM (сервер, БД, доступи)','Узгоджена структура архіву','Запущений Notion AI Hub','Демо-сценарій PO–Invoice–Act'],
      tasks:[
        {id:'1.1',text:'3–4 зустрічі для ревізії ТЗ → PRD v2.0 (Implementation Plan)',role:'both'},
        {id:'1.2',text:'Оновити терміни/логіку процесів (PO, Invoice, Act, архів, погодження)',role:'executor'},
        {id:'1.3',text:'Узгодити ролі, учасників і канали комунікацій',role:'both'},
        {id:'1.4',text:'Розгортання: платформа, БД, SMTP/SFTP/API, ролі, логи, бекапи',role:'executor'},
        {id:'1.5',text:'Аналіз процесів ІР: закупівлі, документообіг, погодження',role:'executor'},
        {id:'1.6',text:'Сесії з фінансами/закупівлями/бухгалтерією → as-is/to-be',role:'both'},
        {id:'1.7',text:'Структура архіву: тип документа, метадані, доступи',role:'executor'},
        {id:'1.8',text:'Підготувати PRD структуру та Project Plan у Notion',role:'executor'},
        {id:'1.9',text:'Погодити Project Plan v1.0 та демо PO–Invoice–Act',role:'both'},
        {id:'1.10',text:'Approval meeting результатів етапу',role:'client'}
      ]},
    { id:2, title:'Етап 2. Документи, довідники та користувачі', duration:'2–3 тижні', goal:'Створити модель даних: типи документів, довідники, контролі, звіти, користувачі та шаблони друку.', period:'preNY',
      results:['Типи документів (PO, Invoice, Act)','Довідники та контролі','Шаблони друку, первинні звіти','Користувачі/ролі/доступи','Архівні дані у системі'],
      tasks:[
        {id:'2.1',text:'Створити PO, Invoice, Act (типи документів)',role:'executor'},
        {id:'2.2',text:'Налаштувати довідники: контрагенти, договори, підрозділи, валюти, статті',role:'executor'},
        {id:'2.3',text:'Контролі: унікальність, узгодження сум/статусів, обов’язкові поля',role:'executor'},
        {id:'2.4',text:'Звіти: Баланс по PO; Баланс по постачальнику',role:'executor'},
        {id:'2.5',text:'Шаблони друку (PDF/XLSX) ↔ узгодження макетів',role:'both'},
        {id:'2.6',text:'Імпорт користувачів (Excel/AD), ролі Viewer/Editor/Approver/Admin',role:'executor'},
        {id:'2.7',text:'Перевірка доступів та імпорт архіва до модуля “Архів”',role:'both'}
      ]},
    { id:3, title:'Етап 3. Бізнес-процеси', duration:'2 тижні', goal:'Налаштувати погодження документів, ролі/доступи за статусами, нотифікації та провести UAT процесів.', period:'preNY',
      results:['Робочі погодження для PO/Invoice/Act','Форми задач/виконавці','Business Process Overview v1.0'],
      tasks:[
        {id:'3.1',text:'Побудувати маршрути погоджень PO/Invoice/Act',role:'executor'},
        {id:'3.2',text:'Стани, правила переходів, виконавці',role:'executor'},
        {id:'3.3',text:'Доступи/ролі залежно від статусу',role:'executor'},
        {id:'3.4',text:'Автоповідомлення авторам про “незакриті” документи',role:'executor'},
        {id:'3.5',text:'UAT погоджень з ключовими користувачами',role:'both'},
        {id:'3.6',text:'За потреби спростити UX (короткі маршрути / групові рішення)',role:'executor'}
      ]},
    { id:4, title:'Етап 4. Реєстри та інтеграції з SAP', duration:'2 тижні', goal:'Забезпечити реєстри документів і обміни з SAP (SFTP/API) з моніторингом і логуванням.', period:'postNY',
      results:['Реєстри погоджених документів','Інтеграції з SAP налаштовано','Протокол інтеграційних тестів'],
      tasks:[
        {id:'4.1',text:'Реєстри Invoice/Act з фільтрами, пошуком, масовими діями',role:'executor'},
        {id:'4.2',text:'SAP: імпорт контрагентів, експорт погоджених документів (SFTP/API)',role:'executor'},
        {id:'4.3',text:'Моніторинг/логування обмінів + алерти збоїв',role:'executor'},
        {id:'4.4',text:'Інтеграційні тести з ІТ-службою клієнта',role:'both'}
      ]},
    { id:5, title:'Етап 5. Тестування та запуск', duration:'2–3 тижні', goal:'Пройти UAT, підготувати інструкції, виправити дефекти і вийти у дослідну експлуатацію (Go-Live).', period:'postNY',
      results:['Система пройшла тестування','Користувачі готові','Акт приймання-передачі','Система в дослідній експлуатації'],
      tasks:[
        {id:'5.1',text:'UAT з клієнтом та формування UAT-команди',role:'both'},
        {id:'5.2',text:'Sandbox для безпечного тестування нових змін',role:'executor'},
        {id:'5.3',text:'Інструкції користувача та адміністратора',role:'executor'},
        {id:'5.4',text:'Виправити помилки / оптимізувати сценарії',role:'executor'},
        {id:'5.5',text:'Підготовка до Go-Live',role:'both'}
      ]},
    { id:6, title:'Етап 6. Післяпроєктна підтримка та розвиток', duration:'постійно', goal:'Моніторинг, оновлення модулів, AI-протоколювання (Notion+n8n), збір фідбеку й план розвитку.', period:'postNY',
      results:['Стабільна робота системи','AI Hub / дайджести','Задокументована історія змін'],
      tasks:[
        {id:'6.1',text:'Моніторинг обмінів, логів, резервного копіювання',role:'executor'},
        {id:'6.2',text:'Оновлення модулів, розширення функцій',role:'executor'},
        {id:'6.3',text:'Автоматичні саммарі/дайджести/архів (Notion + n8n)',role:'executor'},
        {id:'6.4',text:'Збір фідбеку та безперервна UX-оптимізація',role:'both'},
        {id:'6.5',text:'Планування і реалізація покращень',role:'both'}
      ]}
  ]

  const DATA = {
    status:{ phase:'Пілот', scope:'g', schedule:'y', budget:'g', completion:0.62, nextMilestone:{name:'Запуск UAT', due:'2025-10-28'}, need:[ 'Надати доступ до 1С','Підтвердити UAT-сценарії','Призначити UAT-лід' ] },
    milestones:[
      {name:'Розгортання системи', due:'2025-09-30', owner:'DevOps', criteria:'Prod-ready', state:'done'},
      {name:'Налаштування PO',  due:'2025-10-08', owner:'FBPM',   criteria:'PO flow',   state:'done'},
      {name:'Імпорт актів',     due:'2025-10-20', owner:'FBPM',   criteria:'Acts >= 80%', state:'now'},
      {name:'Запуск UAT',       due:'2025-10-28', owner:'PM',     criteria:'UAT plan',   state:'next'},
      {name:'Пром-реліз',       due:'2025-11-10', owner:'PM',     criteria:'Go-live',    state:'next'}
    ],
    diff:[ {t:'+2 задач завершено'},{t:'-1 блокер (OCR таймаут) вирішено'},{t:'+1 новий CR: додати статуси документів у попап'} ],
    filters:['Фаза: Пілот','Модуль: PO','Відповідальний: PM','Тиждень: поточний'],
    docs:[
      {title:'SOW · Договір',         type:'SOW',          status:'Approved', link:'#', owner:'Legal',     updated:'2025-10-10'},
      {title:'ТЗ · FBPM для ІР',      type:'Spec',         status:'Draft',    link:'#', owner:'PM',        updated:'2025-10-17'},
      {title:'Архітектура · Інтеграції', type:'Architecture', status:'Approved', link:'#', owner:'Architect', updated:'2025-10-12'}
    ]
  }

  let TASKS = []
  let INTERACTIONS = []

  const LS_DONE = 'fbpm_plan_doneMap'
  const LS_HIST = 'fbpm_hist'
  const loadJSON = (k,def)=>{ try{ const r=localStorage.getItem(k); return r?JSON.parse(r):def }catch{ return def } }
  const saveJSON = (k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)) }catch{} }
  let DONE_MAP = loadJSON(LS_DONE, {})

  const el = sel => document.querySelector(sel)
  const qsAll = sel => Array.from(document.querySelectorAll(sel))
  const daysLeft = dateStr => { const d = new Date(dateStr); const now = new Date(); const diff = Math.ceil((d - now)/86400000); return diff < 0 ? `прострочено на ${Math.abs(diff)} дн.` : diff }
  const mailtoPM = () => MAIL || 'mailto:pm@example.com?subject=Питання щодо FBPM&body=Привіт!'
  const trimStageTitle = s => { const idx = s.indexOf('. '); return idx>0 ? s.slice(idx+2) : s }

  function isDone(t){
    const s=(t.status||'').toLowerCase()
    return s.includes('done') || s.includes('closed') || s.includes('заверш')
  }
  function isInProgress(t){
    const s=(t.status||'').toLowerCase().replace(/\s+/g,'')
    return s.includes('inprogress') || s.includes('вроботі') || s.includes('триває')
  }
  function isWaiting(t){
    const s=(t.status||'').toLowerCase()
    return s.includes('waiting') || s.includes('pending') || s.includes('очікуван') || s.includes('onhold')
  }
  const byEtaAsc = (a,b)=> new Date(a.eta||'2100-12-31') - new Date(b.eta||'2100-12-31')

  function currentStageName(){
    for (const s of PLAN){
      const all=s.tasks.length
      const done=s.tasks.filter(t=> DONE_MAP[s.id+':'+t.id]).length
      if(done<all) return `Етап ${s.id}. ${trimStageTitle(s.title)}`
    }
    const last=PLAN[PLAN.length-1]
    return `Етап ${last.id}. ${trimStageTitle(last.title)}`
  }

  function heroPlanPct(){
    const total = PLAN.reduce((s,p)=> s + p.tasks.length, 0)
    const done  = PLAN.reduce((s,p)=> s + p.tasks.filter(t => DONE_MAP[p.id+':'+t.id]).length, 0)
    return total ? Math.round(done/total*100) : 0
  }

  function renderHero(){
    el('#phase').textContent = currentStageName()

    // % завершення з Плану (DONE_MAP)
    const pct = heroPlanPct()
    el('#pct').textContent = pct + '%'

    // Активний таск: InProgress; Наступний — останній після активного
    const active = TASKS.filter(isInProgress).sort(byEtaAsc)[0]
    const ordered = TASKS.slice().sort(byEtaAsc)
    const idx = active? ordered.findIndex(t=>t.id===active.id) : -1
    const next = idx>=0 ? (ordered.slice(idx+1).reverse().find(t=>!isDone(t)) || ordered[ordered.length-1]) : ordered.find(t=>!isDone(t))
    el('#nextM').textContent = active? (next? next.title : '—') : (ordered[0]?.title||'—')

    const ms = DATA.milestones.find(m=>m.state==='next' || m.state==='now')
    el('#ddays').textContent = daysLeft((ms&&ms.due)||DATA.status.nextMilestone.due)
    el('#scopeDot').className = 'dot ' + (DATA.status.scope||'g')
    el('#schedDot').className = 'dot ' + (DATA.status.schedule||'g')
    el('#budgetDot').className = 'dot ' + (DATA.status.budget||'g')
    ;['need1','need2','need3'].forEach((id,i)=>{ el('#'+id).textContent = DATA.status.need[i] || '' })
    el('#askPM').setAttribute('href', mailtoPM())
  }

  function renderKPI(){
    const total = TASKS.length
    const done = TASKS.filter(isDone).length
    const overdue = TASKS.filter(t=> new Date(t.eta||'2100-12-31') < new Date() && !isDone(t)).length
    const waiting = TASKS.filter(isWaiting).length
    const modReady = total? Math.round(done/total*100) : 0
    el('#k_done').textContent = String(done)
    el('#k_over').textContent = String(overdue)
    el('#k_dec').textContent  = String(waiting)
    el('#k_mod').textContent  = modReady + '%'
  }

  function renderMilestones(){
    const box = el('#marks'); box.innerHTML = ''
    DATA.milestones.forEach(m=>{
      const div = document.createElement('div'); div.className = 'mark ' + m.state
      div.innerHTML = '<div class="when">'+m.due+'</div><div class="name">'+m.name+'</div><div class="muted">'+m.owner+'</div>'
      div.title = 'Критерії: '+m.criteria; box.appendChild(div)
    })
    const idxNow = DATA.milestones.findIndex(x=>x.state==='now')
    const after = idxNow>=0 ? DATA.milestones[idxNow+1] : DATA.milestones.find(x=>x.state==='next')
    if(after){ DATA.status.nextMilestone = { name: after.name, due: after.due } }
  }

  function renderGantt(){
    const tasks = TASKS.filter(t=> t.eta)
    const host = document.querySelector('#ms-title').parentElement.parentElement
    let svg = host.querySelector('svg.gantt')
    if(!tasks.length){ if(svg) svg.remove(); return }
    const min = new Date(Math.min(...tasks.map(t=>+new Date(t.eta))));
    const max = new Date(Math.max(...tasks.map(t=>+new Date(t.eta))));
    const pad = 24, rowH = 18, w = host.clientWidth-32, h = (tasks.length*rowH)+pad*2
    const x = d => pad + ( (new Date(d)-min) / (max-min || 1) ) * (w-pad*2)
    const bars = tasks.map((t,i)=>({ y: pad + i*rowH, x0: pad, x1: x(t.eta), label: (t.title||'') }))
    const ns='http://www.w3.org/2000/svg'
    if(svg) svg.remove(); svg = document.createElementNS(ns,'svg'); svg.setAttribute('class','gantt'); svg.setAttribute('width','100%'); svg.setAttribute('height',String(h))
    const axis = document.createElementNS(ns,'line'); axis.setAttribute('x1',pad); axis.setAttribute('y1',pad/2); axis.setAttribute('x2',w-pad); axis.setAttribute('y2',pad/2); axis.setAttribute('stroke','#D7D5F4'); svg.appendChild(axis)
    bars.forEach(b=>{
      const r=document.createElementNS(ns,'rect'); r.setAttribute('x',b.x0); r.setAttribute('y',b.y); r.setAttribute('width',Math.max(6,b.x1-b.x0)); r.setAttribute('height',10); r.setAttribute('rx',5); r.setAttribute('fill','url(#g)'); svg.appendChild(r)
      const t=document.createElementNS(ns,'text'); t.setAttribute('x',b.x1+6); t.setAttribute('y',b.y+9); t.setAttribute('font-size','11'); t.setAttribute('fill','#4B5563'); t.textContent=b.label; svg.appendChild(t)
    })
    const defs=document.createElementNS(ns,'defs')
    const grad=document.createElementNS(ns,'linearGradient'); grad.setAttribute('id','g'); grad.setAttribute('x1','0'); grad.setAttribute('x2','1'); grad.innerHTML='<stop offset="0%" stop-color="#392EC9"/><stop offset="100%" stop-color="#EF0650"/>'
    defs.appendChild(grad); svg.appendChild(defs)
    host.appendChild(svg)
  }

  function renderDiff(){
    const d = el('#diff'); d.innerHTML = ''
    DATA.diff.forEach(x=>{ const li=document.createElement('li'); li.className='item'; li.textContent=x.t; d.appendChild(li) })
    const f = el('#filters'); f.innerHTML=''
    DATA.filters.forEach(x=>{ const s=document.createElement('span'); s.className='chip'; s.textContent=x; f.appendChild(s) })
  }

  function renderDocs(filter){
    const box = el('#docs'); box.innerHTML=''
    DATA.docs.filter(d => !filter || d.status===filter).forEach(d=>{
      const c=document.createElement('div'); c.className='card'
      c.innerHTML = '<div class="muted">'+d.type+' · '+d.status+'</div><div class="title" style="margin:4px 0 6px">'+d.title+'</div><a class="btn" href="'+d.link+'">Відкрити</a><div class="muted" style="margin-top:6px">'+d.owner+' · '+d.updated+'</div>'
      box.appendChild(c)
    })
  }

  function mapType(t){
    const s=(t||'').toString().trim().toLowerCase()
    if (['task','таск','завдання','таcк','тask'].includes(s)) return 'task'
    if (['meeting','зустріч'].includes(s)) return 'зустріч'
    if (['decision','рішення'].includes(s)) return 'рішення'
    if (['question','питання'].includes(s)) return 'питання'
    if (['answer','відповідь'].includes(s)) return 'відповідь'
    if (['note','нотатка'].includes(s)) return 'нотатка'
    return 'нотатка'
  }

  function renderHistory(items){
    const body=el('#histBody'); body.innerHTML=''
    const tag=(el('#searchTag').value||'').trim().toLowerCase()
    items
      .filter(m=>!tag||(((m.summary||'')+' '+(m.title||'')).toLowerCase().includes(tag)))
      .slice(0,10)
      .forEach(m=>{
        const tr=document.createElement('tr')
        const link=m.link? '<a href="'+m.link+'" target="_blank" rel="noopener">Лінк</a>' : ''
        const dateStr=(new Date(m.date)).toLocaleDateString('uk-UA')
        tr.innerHTML = '<td>'+dateStr+'</td><td>'+m.type+'</td><td>'+(m.title||'')+'</td><td>'+(m.summary||'')+'</td><td>'+link+'</td>'
        body.appendChild(tr)
      })
  }

  async function histLoad(){
    try{
      const r = await fetch(HIST_GET_ENDPOINT, { method:'GET' })
      if(!r.ok) throw new Error(r.status)
      const raw = await r.text()
      let j; try{ j = JSON.parse(raw) }catch{ console.warn('hist JSON parse fail'); return }
      let list=[]
      if(Array.isArray(j)){ list = Array.isArray(j[0] && j[0].list)? j[0].list : j }
      else if (j && Array.isArray(j.list)){ list = j.list }
      const norm = (list||[]).map((x,i)=>({
        id: String((x?.ExtID || x?.id) || (Date.now()+'-'+i)),
        date: (x?.DateEdit || x?.date || x?.Date || new Date().toISOString()),
        type: mapType(x?.Type || x?.type),
        title: (x?.Name || x?.title) || '',
        summary: (x?.Description || x?.Text || x?.summary) || '',
        link: (x?.Link || x?.link) || '',
        status: (x?.Status || x?.status) || '',
        eta: (x?.ETA || x?.eta || x?.due || x?.DueDate || ''),
        owner: (x?.Owner || x?.owner || x?.Assignee || ''),
        prio: (x?.Priority || x?.prio || x?.PriorityName || ''),
        phase: (x?.Phase || x?.phase || ''),
        mod: (x?.Module || x?.mod || '')
      }))
      TASKS = norm.filter(x=> x.type==='task').sort(byEtaAsc)
      INTERACTIONS = norm.filter(x=> x.type!=='task').sort((a,b)=> new Date(b.date)-new Date(a.date))
      saveJSON(LS_HIST, INTERACTIONS)
      renderHistory(INTERACTIONS); renderTasks('all','all'); renderKPI(); renderMilestones(); renderHero(); renderGantt()
    }catch(e){
      const cached=loadJSON(LS_HIST,[])
      renderHistory(cached); renderTasks('all','all'); renderKPI(); renderMilestones(); renderHero(); renderGantt()
    }
  }

  async function addHist(){
    const title=el('#histTitle').value.trim()
    const summary=el('#histSummary').value.trim()
    const type=el('#histType').value
    const link=el('#histLink').value.trim()
    if(!title && !summary) return

    const it={ id: String(Date.now()), date: new Date().toISOString(), type, title, summary, link }

    try{
      await fetch(HIST_POST_ENDPOINT, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ list:[it] })
      })
    }catch(e){ console.warn('POST fail, caching locally', e) }

    const cur=loadJSON(LS_HIST,[])
    const next=[it, ...cur]
    saveJSON(LS_HIST,next)
    renderHistory(next)
    el('#histTitle').value=''; el('#histSummary').value=''; el('#histLink').value=''
  }

  let STAGE_FILTER='all'
  let ROLE_FILTER=new Set(['executor','client','both'])

  function renderPlan(){
    const box=el('#planWrap'); box.innerHTML=''
    PLAN.filter(s=> STAGE_FILTER==='all' || s.period===STAGE_FILTER).forEach(s=>{
      const stage=document.createElement('div'); stage.className='stage'
      const all=s.tasks.length
      const done=s.tasks.filter(t=> DONE_MAP[s.id+':'+t.id]).length
      const pct=Math.round(done/Math.max(1,all)*100)
      const headingTitle='Етап '+s.id+' · '+trimStageTitle(s.title)
      stage.innerHTML='<div class="row" style="justify-content:space-between;align-items:center"><div><div class="title">'+headingTitle+'</div><div class="muted">Тривалість: '+s.duration+' · Мета: '+s.goal+'</div></div><div class="muted">Прогрес: <strong>'+done+'/'+all+' ('+pct+'%)</strong></div></div>'
      const grid=document.createElement('div'); grid.className='row'; grid.style.gap='16px'
      const left=document.createElement('div'); left.style.flex='2'
      const right=document.createElement('aside'); right.style.flex='1'
      s.tasks.filter(t=> ROLE_FILTER.has(t.role)).forEach(t=>{
        const k=s.id+':'+t.id; const mark=!!DONE_MAP[k]
        const line=document.createElement('div'); line.className='task'
        const cbId='cb_'+k
        const roleCls = t.role==='executor'? 'role-ex' : (t.role==='client'? 'role-cl' : 'role-bo')
        line.innerHTML='<input id="'+cbId+'" type="checkbox" '+(mark?'checked':'')+' style="margin-top:4px">' +
          '<label for="'+cbId+'" style="flex:1">'+t.id+' · '+t.text+'</label>' +
          '<span class="badge '+roleCls+'">'+(t.role==='executor'?'виконавець':(t.role==='client'?'клієнт':'разом'))+'</span>'
        left.appendChild(line)
        line.querySelector('input').addEventListener('change',(e)=>{
          DONE_MAP[k]=e.target.checked; saveJSON(LS_DONE,DONE_MAP); renderPlan(); renderHero()
        })
      })
      const resTitle=document.createElement('div'); resTitle.className='title'; resTitle.style.marginBottom='6px'; resTitle.textContent='Результати етапу'
      right.appendChild(resTitle)
      const ul=document.createElement('ul'); ul.className='list'
      s.results.forEach(r=>{ const li=document.createElement('li'); li.className='item'; li.textContent=r; ul.appendChild(li) })
      right.appendChild(ul)
      grid.appendChild(left); grid.appendChild(right); stage.appendChild(grid); box.appendChild(stage)
    })
  }

  function renderTasks(filterKey, filterVal){
    const body = el('#taskBody'); body.innerHTML=''
    const src = (filterKey==='all')? TASKS : TASKS.filter(t=> !filterKey || (t[filterKey]===filterVal))
    src.forEach(t=>{
      const tr=document.createElement('tr')
      tr.innerHTML='<td>'+(t.title||t.name||'')+'</td><td>'+(t.prio||t.priority||'')+'</td><td>'+(t.owner||'')+'</td><td>'+(t.eta||'')+'</td><td>'+(t.status||'')+'</td>'
      body.appendChild(tr)
    })
  }

  // --- initial renders ---
  renderDiff()
  renderDocs()
  renderPlan()
  renderMilestones()
  histLoad()

  // --- interactions ---
  function toggleActiveChip(chips, target){ chips.forEach(x=>x.classList.remove('active')); target.classList.add('active') }
  qsAll('[data-f]').forEach(ch => ch.addEventListener('click', () => {
    const [k,v] = ch.dataset.f.split(':')
    renderTasks(k, v)
    toggleActiveChip(qsAll('[data-f]'), ch)
  }))
  qsAll('[data-sf]').forEach(ch => ch.addEventListener('click', () => {
    STAGE_FILTER = ch.dataset.sf
    renderPlan()
    toggleActiveChip(qsAll('[data-sf]'), ch)
  }))
  qsAll('[data-rf]').forEach(ch => ch.addEventListener('click', () => {
    const v = ch.dataset.rf
    ch.classList.toggle('active')
    if(ROLE_FILTER.has(v)) ROLE_FILTER.delete(v); else ROLE_FILTER.add(v)
    renderPlan()
  }))
  qsAll('[data-docf]').forEach(ch => ch.addEventListener('click', () => {
    qsAll('[data-docf]').forEach(x=>x.classList.remove('active'))
    ch.classList.add('active')
    renderDocs(ch.dataset.docf)
  }))
  el('#searchTag').addEventListener('input', ()=>{ renderHistory(INTERACTIONS) })
  el('#histAdd').addEventListener('click', addHist)
  el('#btnFilters').addEventListener('click', ()=>alert('Фільтри: фаза · модуль · відповідальний · період (TODO: модальне вікно)'))
</script>

</body>
</html>
